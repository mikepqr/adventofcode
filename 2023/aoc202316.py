from __future__ import annotations

from collections import defaultdict, deque
from dataclasses import dataclass


@dataclass(frozen=True)
class Vector:
    x: int
    y: int

    def __add__(self, other: Vector) -> Vector:
        return Vector(self.x + other.x, self.y + other.y)


LEFT = Vector(-1, 0)
RIGHT = Vector(1, 0)
UP = Vector(0, -1)
DOWN = Vector(0, 1)

DIRECTIONS = {
    LEFT: "left",
    RIGHT: "right",
    UP: "up",
    DOWN: "down",
}


@dataclass
class Tile:
    c: str
    left: tuple[Vector, ...]
    right: tuple[Vector, ...]
    up: tuple[Vector, ...]
    down: tuple[Vector, ...]

    def __repr__(self):
        return self.c


EMPTY = Tile(
    c=".",
    left=(LEFT,),
    right=(RIGHT,),
    up=(UP,),
    down=(DOWN,),
)

SLASH = Tile(
    c="/",
    left=(DOWN,),
    right=(UP,),
    down=(LEFT,),
    up=(RIGHT,),
)

BACKSLASH = Tile(
    c="\\",
    left=(UP,),
    right=(DOWN,),
    down=(RIGHT,),
    up=(LEFT,),
)

DASH = Tile(
    c="-",
    left=(LEFT,),
    right=(RIGHT,),
    up=(LEFT, RIGHT),
    down=(LEFT, RIGHT),
)

BAR = Tile(
    c="|",
    left=(UP, DOWN),
    right=(UP, DOWN),
    down=(DOWN,),
    up=(UP,),
)

TILES = {
    ".": EMPTY,
    "/": SLASH,
    "\\": BACKSLASH,
    "-": DASH,
    "|": BAR,
}


data = r"""
.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....
""".strip()


class Map:
    def __init__(self, data: str):
        self.map = [[TILES[c] for c in line] for line in data.splitlines()]
        self.nx = len(self.map[0])
        self.ny = len(self.map)

    def __contains__(self, loc: Vector):
        return 0 <= loc.x < self.nx and 0 <= loc.y < self.ny

    def __getitem__(self, loc: Vector):
        return self.map[loc.y][loc.x]


def print_map(map, activated):
    out = []
    DIRECTION_CHAR = {
        LEFT: "<",
        RIGHT: ">",
        UP: "^",
        DOWN: "v",
    }
    for y, row in enumerate(map.map):
        line = ""
        for x, tile in enumerate(row):
            directions = activated.get(Vector(x, y))
            if not directions or tile.c != EMPTY.c:
                line += tile.c
            elif len(directions) > 1:
                line += str(len(directions))
            else:
                (direction,) = directions
                line += DIRECTION_CHAR[direction]
        out.append(line)
    return out


def n_activated(map, start, direction):
    # queue of (loc, direction _before_ interacting with any mirror at loc)
    q = deque()
    q.append((start, direction))

    # dict mapping location to a set of directions from which it was activated
    activated = defaultdict(set)

    while q:
        loc, direction = q.pop()
        if direction in activated[loc]:
            # exit early if we've already been in this tile going in this
            # direction to prevent loops
            continue
        activated[loc].add(direction)

        for new_direction in getattr(map[loc], DIRECTIONS[direction]):
            if loc + new_direction in map:
                q.append((loc + new_direction, new_direction))

    return len(activated)


def part1():
    map = Map(data)
    return n_activated(map, Vector(0, 0), RIGHT)


def part2():
    map = Map(data)
    starts = (
        [(Vector(x, 0), DOWN) for x in range(map.nx)]
        + [(Vector(x, map.ny - 1), UP) for x in range(map.nx)]
        + [(Vector(0, y), RIGHT) for y in range(map.ny)]
        + [(Vector(map.nx - 1, y), LEFT) for y in range(map.ny)]
    )
    return max(n_activated(map, *start) for start in starts)


data = r"""
\|.......|........|...../........................\.\.......\...-../..........\.........|...\......|...........
.|.../............|.....|\..../....-.\...........-............./......................|.-.-...........\.....-.
...............|........-....-...../..../|./.............\..|..................\..........|\.........../.\....
....................|\..................\..................\/....................-....../................\.|..
......././-......................................|.....|./.............................../....................
.......................\.....|............-...\..|......-./...\.........../.............|..-......-...../.....
.....................-.......\.......|............./........\.......|........../............/.................
..................-................-./....................|....|...................-..................\.......
|.......././.................................|.....-............................-.........|......../../.......
.........../.......-........|................/......-....|.......\/..|..\...|..............-....\....|...-....
............./-......./.....-./....\........./..|...............|..-......................-...................
......-\.\..|/......-.|.........-.......-..\|.............................\.-.............\...............\...
......\..../................\.........\..|...............-.......|..-|.....|-..........................-......
.....\....../../..........\......-...........\.......-.\........./...........|\............-.............\....
........\....................|........./...................|.........-.........\..............................
.........-|.............\-.............................-..............|.....\../......|/......................
..................../.......\/......./................../...../.......................|......|./.-......-|....
..................../.........|..-.-./....../.|-..\..|........|......-.................\...\........./...\....
....-...-....../...............................................|....................\..-..............-..|.-.\
..........\..\.\....................-...|......................\......|......-.................\....|....../..
\................../.....-./.......-...........\..../....../....|.........|........................|..........
../......\.|..............................|../......................-.\..........\...............|..........|.
.|..............................-...-........|...-........|........../............\...../.\......-....|.......
............./...................\.\.........|...|../..........-.......\........../.-.-.....-..........-......
..........................-.|\......|......./|.............../..../......--.....|.........|........../........
/-....|/...-|..........\......................./..........-.....-.............\....../................\.......
............-../............\...............................-.........\...\...........|-....|.................
..............................|........-.........-..................|...........................-.............
........./...............//.........................................-..........|............|..../............
...\..||../........................./................|......./.......|....|.....|............|................
........./...................\-./.......\...../............../..........-|...................|..../.......|...
...../................/..-............../....................|/......................................-.|......
\|........................................\...........-......../...\.|......|..\../........|.......\..........
..|/......\....-...............||......//..................\\..-./...-....................|...................
./....../................\../.\.....\.........\.\\\..........................-..\..-............./-...........
........|..........-.....|..\..../....../.................../.............\...-.\...........\...........-.....
..........\...|/..|......|\/./...........-.|.................-.|....|....................../..................
-.......................-.|.............-../......./.../...-|..|.........../../..\............\../..........|.
................./.........\..........-.........../..|.......//..............|..................|.....\.......
.............-../......\./.../.|.|.....-..|.....|...\.........|.....-/..................-................|....
|.-\..../...........-.....|....................//........\............./....../........./../\..\....-.........
......\.|...........|..............|............/....-../.....\..................../...................|......
../|....\....................................-.....--...|....../........-...................|...\.......\.....
..........|../..-.........-...........|....................../............/.......................|.|.........
........./..................\............................\..............|..................................\..
...-|...........-......\|\...........\...\.........|..../......../..../..../..-|||................-...........
..|....-\..\......./...........\\.................................|......-./.............../........|..--.....
.................................../|...........-.......-...|..-............-........../......................
.......|.............|.......................................................\...............\................
........\.......|...........|............................\-......................................|............
......|..\.-../......................|.-.../.....-..|.-.................................-.......\......./.|...
--\...../..........-...........\...................../.....|/............\..............-............./.......
......|-...............\........................................../.-\..|.....-........|..\./../.-..........|.
.........................//.....-...................|...|..-.\....|................|......\..-............/...
./.........-...-....................../......\\......||..........|....................--.................../..
....-........\........................../..........|........./.........................\.\....|.......-|......
.|\/...............|...-.|....|../..|...|...../......\..........|.............|........\.....|................
...../.-\.-................|......../....-..\......|/.......\.......................\.......................|.
......................|..........-..../..../.\../................../......................|..............\|...
........../-\......|............................../....-......................................./..............
./..........|.....-.............-..-...|../........\.-...........|.........................-................-.
.-....-................|..................-...-...........-........|.|..........-.-...........................
...|...............|.................\.......|.............../................\....|.............|.........\..
..\..............|.............\..................\.......................|..........-........................
../........./............\.\../.........................\../.....-....|....................-............../...
...\................\......../......................./\....\..-........\........./..\.........................
.........../..|.......-.........-|..............................................\...............-./\||...../..
...............\........-..|..........||......................../..........-...../........................\...
...........\.....................-................................................................|..........|
./.........-.......-................................\..........||..|.|..\.........\.../..||......-.......\....
\......\.........-..\......\...................-..|.....\.....\....................|..........-......-........
.............|..........\..........-..................\.\..........|.....................|.............-/.....
........-................|......./..-...............\......|-...\.....\.............|./..\\../....-.../.......
..................\..||.............-........|............/.........\../...\..|/.....\.........\..........|...
..|../..................\..............................|...........................................-..........
\..................../.|.......\...|-............../......\.............././..-...................|...........
......./..............................\..................|................\............./....-.....-..........
..............|.........../...............................\.................\..|........-.......-.\.....|.....
.................|.....\........................................-.\.\..\...................//.....\./.........
....../..........|..-............/..........\............../.............|....................................
.............|..........-.|..\..........-....\...........................|.....................\.\....-.......
..........\............../........-........|.....-./...........................................\..........\...
..........|.-...|.|...............-...|.|..................-...-........|/.../.............................\..
.............-....\.....................................................\........................|...........\
..\|...........|....-.-|........................................|.............................\.....\.-|......
...........//.|.............-......\.........................|............-|...............././.....|....|....
.............../.\...............--........|........-....\..../.........-.....................-......../...-..
.....|......\.........../............/..................../.........|...........-.......-.|...........-.......
.................-........./..........|...................../..........................|.|...........-.......|
.....|...-........|...................../.../...................................\.............\...|...........
.............\.......|........................./....|........./........\.........\.......................\....
............................/-..................................../........-..............\...|.....\..|\.....
...-..././....................-.......|................./..........-.....|.|..............\..........-....\...
.....\\......\...............................-...-........-.|..../........\.\.....-.....................|.....
..............\.........\.\.|..........-......//./.../....|.............-.../..|.........................\....
...................../...........\.........................\.-..|..........|........./|...............|/...\|.
..|.-./.............-.........././.|......../.......\...........-.........../..........\.....-.........-......
.....|......\....-.........-.............|.......|-........|-...-../-..|.......-................-.............
.................|.........|....\................................/.-.....|........./..../..........-..........
-....\......./......\.\..................-..|./......-...\.\...-.........................\.............|......
......................./..............\/..........-................../............\.......\..\.......\....../.
.|...............//.................................../.......\.......\.\..........-\...|............-........
.../......................|.....-.........../................-.../............../.........\.\.../........../..
..................................|\..................-../........-./..\......./....|../.......|-.............
.....\..........|................/........\..........-......../\../..../.\-.|...\....|\.............\|..--....
................./................................././|..../..........|............../............../.........
..............|......|.......\....|...|......|..................................\.......-....\/...........|...
......./\..................................-......./......\....\..-..................-................\......|
...........-.........../..............\............|....../....../.......\........./......../..\.........\...-
.-..................\............................/\...................|...........|....\....\--/............/.
""".strip()

if __name__ == "__main__":
    print(part1())
    print(part2())
